import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { saveAs } from "file-saver";
import * as XLSX from "xlsx";

export default function BartGame() {
  const totalBalloons = 45;
  const [currentBalloon, setCurrentBalloon] = useState(1);
  const [inflateCount, setInflateCount] = useState(0);
  const [totalScore, setTotalScore] = useState(0);
  const [balloonScore, setBalloonScore] = useState(0);
  const [balloonSize, setBalloonSize] = useState(150);
  const [balloonPopped, setBalloonPopped] = useState(false);
  const [message, setMessage] = useState("");
  const [countdown, setCountdown] = useState(6);
  const [isWaiting, setIsWaiting] = useState(false);
  const [pumpTimes, setPumpTimes] = useState([]);
  const [pumpStart, setPumpStart] = useState(null);
  const [data, setData] = useState([]);

  useEffect(() => {
    const handleKeyPress = (e) => {
      if (e.key === "Enter") handlePump();
      if (e.code === "Space") handleCollect();
    };
    window.addEventListener("keydown", handleKeyPress);
    return () => window.removeEventListener("keydown", handleKeyPress);
  }, [inflateCount, balloonPopped, isWaiting]);

  const handlePump = () => {
    if (balloonPopped || isWaiting) return;
    if (!pumpStart) setPumpStart(Date.now());

    const pumpTime = Date.now() - (pumpStart || Date.now());
    setPumpTimes((prev) => [...prev, pumpTime]);
    setPumpStart(Date.now());

    const popChance = 1 / (68 - inflateCount);
    const rand = Math.random();

    if (rand < popChance || inflateCount >= 64) {
      handlePop();
    } else {
      setInflateCount((prev) => prev + 1);
      setBalloonScore((prev) => prev + 5);
      setBalloonSize((prev) => prev + 10);
    }
  };

  const handlePop = () => {
    setBalloonPopped(true);
    setMessage("بادکنک شما ترکید");
    saveBalloonData(0, true);
    startCountdown();
  };

  const handleCollect = () => {
    if (balloonPopped || isWaiting) return;
    setTotalScore((prev) => prev + balloonScore);
    setMessage(`شما ${balloonScore} امتیاز به دست آوردید`);
    saveBalloonData(balloonScore, false);
    startCountdown();
  };

  const saveBalloonData = (score, popped) => {
    const meanPumpTime = pumpTimes.reduce((a, b) => a + b, 0) / (pumpTimes.length || 1);
    setData((prev) => [
      ...prev,
      {
        balloonNumber: currentBalloon,
        totalPumps: inflateCount,
        score,
        popped: popped ? "ترکیده" : "نترکیده",
        totalTime: pumpTimes.reduce((a, b) => a + b, 0),
        meanPumpTime,
        pumpDeviationFrom32: inflateCount - 32,
        eachPumpTimes: pumpTimes.join(", ")
      }
    ]);
  };

  const startCountdown = () => {
    setIsWaiting(true);
    let counter = 6;
    const interval = setInterval(() => {
      counter--;
      setCountdown(counter);
      if (counter === 0) {
        clearInterval(interval);
        nextBalloon();
      }
    }, 1000);
  };

  const nextBalloon = () => {
    if (currentBalloon >= totalBalloons) {
      downloadExcel();
      return;
    }
    setCurrentBalloon((prev) => prev + 1);
    setInflateCount(0);
    setBalloonScore(0);
    setBalloonSize(150);
    setBalloonPopped(false);
    setMessage("");
    setCountdown(6);
    setIsWaiting(false);
    setPumpTimes([]);
    setPumpStart(null);
  };

  const downloadExcel = () => {
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "BART Data");
    const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const fileData = new Blob([excelBuffer], { type: "application/octet-stream" });
    saveAs(fileData, "bart_data.xlsx");
  };

  return (
    <div
      className="min-h-screen flex flex-col items-center justify-start p-8 bg-cover bg-center"
      style={{ backgroundImage: "url('/a_peaceful_cartoon_landscape_background_for_a_psyc.png')" }}
    >
      <h1 className="text-4xl font-bold mb-4">بیشترین امتیاز رو بیار</h1>

      <div className="flex space-x-4 mb-4">
        <Button onClick={handlePump} disabled={isWaiting}>باد کردن</Button>
        <Button onClick={handleCollect} disabled={isWaiting}>جمع کردن</Button>
      </div>

      <div className="relative w-64 h-64 flex justify-center items-center">
        {balloonPopped ? (
          <img src="/pop.png" alt="ترکید" className="w-32 h-32" />
        ) : (
          <img
            src="/Balloon1.png"
            alt="بادکنک"
            style={{ width: balloonSize, height: balloonSize }}
          />
        )}
      </div>

      <div className="mt-4 text-center text-xl">
        <p>{message}</p>
        {isWaiting && <p>شروع در: {countdown}</p>}
      </div>

      <div className="absolute top-4 right-4 text-right space-y-2">
        <p>مجموع امتیاز شما: {totalScore}</p>
        <p>شمارنده‌ی باد: {inflateCount}</p>
        <p>بادکنک {currentBalloon} از 45 بادکنک</p>
      </div>
    </div>
  );
}
