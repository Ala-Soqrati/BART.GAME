<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بازی بادکنک</title>
  <style>
    body {
      background-image: url('background.png');
      background-size: cover;
      font-family: Tahoma, sans-serif;
      color: #333;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      text-align: center;
    }

    #balloon {
      width: 150px;
      transition: width 0.3s, height 0.3s;
    }

    #buttons {
      margin-bottom: 20px;
    }

    button {
      font-size: 18px;
      padding: 8px 16px;
      margin: 10px;
      cursor: pointer;
      width: 120px;
    }

    #counter, #score, #balloonNumber {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }

    #message, #countdown {
      margin-top: 20px;
      font-size: 22px;
      color: red;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      #balloon {
        width: 120px;
      }

      button {
        font-size: 16px;
        padding: 6px 12px;
        width: 100px;
      }

      #counter, #score, #balloonNumber {
        font-size: 16px;
      }

      #message, #countdown {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

  <h1>بازی بادکنک</h1>

  <!-- Buttons are now above the balloon -->
  <div id="buttons">
    <button onclick="pumpBalloon()">باد کردن</button>
    <button onclick="collectPoints()">جمع کردن</button>
  </div>

  <img id="balloon" src="Balloon1.png" alt="Balloon">
  
  <div id="counter">تعداد پمپ: 0</div>
  <div id="score">امتیاز: 0</div>
  <div id="balloonNumber">شماره بادکنک: 1/45</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let pumpCount = 0;
    let points = 0;
    let totalPoints = 0;
    let balloonIndex = 1;
    let balloonWidth = 150;
    let balloonExploded = false;
    let startTime = 0;
    let pumpTimes = [];
    let balloonData = [];

    function resetBalloon() {
      pumpCount = 0;
      points = 0;
      balloonWidth = 150;
      balloonExploded = false;
      document.getElementById('balloon').src = 'Balloon1.png';
      document.getElementById('balloon').style.width = balloonWidth + 'px';
      document.getElementById('counter').innerText = "تعداد پمپ: 0";
      document.getElementById('score').innerText = "امتیاز: 0";
      document.getElementById('balloonNumber').innerText = `شماره بادکنک: ${balloonIndex}/45`;
      document.getElementById('message').innerText = "";
      document.getElementById('countdown').innerText = "";
      pumpTimes = [];
      startTime = Date.now();
    }

    function pumpBalloon() {
      if (balloonExploded) return;

      const pumpStart = Date.now();
      pumpCount++;
      points += 5;
      document.getElementById('counter').innerText = `تعداد پمپ: ${pumpCount}`;
      document.getElementById('score').innerText = `امتیاز: ${points}`;
      
      balloonWidth += 5; // Smaller growth per pump
      if (balloonWidth > 250) {  // Limit the balloon size
        balloonWidth = 250;
      }
      document.getElementById('balloon').style.width = balloonWidth + 'px';
      
      const timePerPump = (pumpStart - startTime) / 1000;
      pumpTimes.push(timePerPump.toFixed(2));
      startTime = pumpStart;

      if (shouldExplode()) {
        explodeBalloon();
      }
    }

    function shouldExplode() {
      let probability = 1 / (128 - pumpCount + 1);
      return Math.random() < probability;
    }

    function explodeBalloon() {
      balloonExploded = true;
      document.getElementById('balloon').src = 'pop.png';
      document.getElementById('message').innerText = ".بادکنک شما ترکید";
      startCountdown();
      saveBalloonData(true);
    }

    function collectPoints() {
      if (balloonExploded) return;

      document.getElementById('message').innerText = `شما ${points}امتیاز دریافت کردید`;
      saveBalloonData(false);
      setTimeout(nextBalloon, 2000);
    }

    function startCountdown() {
      let count = 6; // Changed to 6 seconds
      document.getElementById('countdown').innerText = count;
      let interval = setInterval(() => {
        count--;
        document.getElementById('countdown').innerText = count;
        if (count < 0) {
          clearInterval(interval);
          nextBalloon();
        }
      }, 1000);
    }

    function nextBalloon() {
      balloonIndex++;
      if (balloonIndex > 45) {
        endGame();
      } else {
        resetBalloon();
      }
    }

    function saveBalloonData(exploded) {
      let avgTime = pumpTimes.length > 0 ? (pumpTimes.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / pumpTimes.length).toFixed(2) : 0;
      let totalTime = pumpTimes.length > 0 ? pumpTimes.reduce((a, b) => parseFloat(a) + parseFloat(b), 0).toFixed(2) : 0;
      let deviation = pumpCount - 64;

      balloonData.push({
        "شماره بادکنک": balloonIndex,
        "آیا ترکید؟": exploded ? "ترکید" : "ترک نکرد",
        "امتیاز کسب شده": points,
        "تعداد باد کردن": pumpCount,
        "زمان کل (ثانیه)": totalTime,
        "میانگین زمان هر باد کردن (ثانیه)": avgTime,
        "انحراف از 64": deviation,
        "زمان‌های هر باد کردن (ثانیه)": pumpTimes.join(", ")
      });

      if (!exploded) {
        totalPoints += points;
      }
    }

    function endGame() {
      document.getElementById('buttons').style.display = 'none';
      document.getElementById('message').innerText = `جمع امتیاز دریافتی شما: ${totalPoints}امتیاز`;
      downloadExcel();
    }

    function downloadExcel() {
      let wb = XLSX.utils.book_new();
      let ws = XLSX.utils.json_to_sheet(balloonData);
      XLSX.utils.book_append_sheet(wb, ws, "BalloonGame");
      XLSX.writeFile(wb, "balloon_game_data.xlsx");
    }

    resetBalloon();

    // Listen for the Enter key press to inflate the balloon
    window.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        pumpBalloon(); // Inflate the balloon on Enter key press
      }
    });
  </script>

</body>
</html>
